

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BirchRest Documentation &mdash; birchrest 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=8d563738"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="birchrest" href="modules.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="#" class="icon icon-home">
            birchrest
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="modules.html">birchrest</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">birchrest</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="#" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">BirchRest Documentation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="birchrest-documentation">
<h1>BirchRest Documentation<a class="headerlink" href="#birchrest-documentation" title="Link to this heading"></a></h1>
<div class="toctree-wrapper compound">
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="modules.html">birchrest</a><ul>
<li class="toctree-l2"><a class="reference internal" href="birchrest.html">birchrest package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="birchrest.html#subpackages">Subpackages</a><ul>
<li class="toctree-l4"><a class="reference internal" href="birchrest.app.html">birchrest.app package</a></li>
<li class="toctree-l4"><a class="reference internal" href="birchrest.decorators.html">birchrest.decorators package</a></li>
<li class="toctree-l4"><a class="reference internal" href="birchrest.exceptions.html">birchrest.exceptions package</a></li>
<li class="toctree-l4"><a class="reference internal" href="birchrest.http.html">birchrest.http package</a></li>
<li class="toctree-l4"><a class="reference internal" href="birchrest.middlewares.html">birchrest.middlewares package</a></li>
<li class="toctree-l4"><a class="reference internal" href="birchrest.routes.html">birchrest.routes package</a></li>
<li class="toctree-l4"><a class="reference internal" href="birchrest.types.html">birchrest.types package</a></li>
<li class="toctree-l4"><a class="reference internal" href="birchrest.unittest.html">birchrest.unittest package</a></li>
<li class="toctree-l4"><a class="reference internal" href="birchrest.utils.html">birchrest.utils package</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="birchrest.html#submodules">Submodules</a></li>
<li class="toctree-l3"><a class="reference internal" href="birchrest.html#birchrest-core-module">birchrest.core module</a></li>
<li class="toctree-l3"><a class="reference internal" href="birchrest.html#module-birchrest.version">birchrest.version module</a></li>
<li class="toctree-l3"><a class="reference internal" href="birchrest.html#module-birchrest">Module contents</a><ul>
<li class="toctree-l4"><a class="reference internal" href="birchrest.html#birchrest.BirchRest"><code class="docutils literal notranslate"><span class="pre">BirchRest</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="birchrest.html#birchrest.Controller"><code class="docutils literal notranslate"><span class="pre">Controller</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="birchrest.html#birchrest.Middleware"><code class="docutils literal notranslate"><span class="pre">Middleware</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<section id="birchrest">
<h2>BirchRest<a class="headerlink" href="#birchrest" title="Link to this heading"></a></h2>
<p><a class="reference external" href="https://pypi.org/project/birchrest/"><img alt="PyPI version" src="https://badge.fury.io/py/birchrest.svg" /></a>
<a class="reference internal" href="#LICENSE"><span class="xref myst"><img alt="License: MIT" src="https://img.shields.io/badge/License-MIT-blue.svg" /></span></a>
<a class="reference external" href="https://pypi.org/project/birchrest/"><img alt="Python Versions" src="https://img.shields.io/pypi/pyversions/birchrest.svg" /></a>
<img alt="Unit Tests" src="https://github.com/alexandengstrom/birchrest/actions/workflows/unit_test.yml/badge.svg" />
<img alt="Type Checking" src="https://github.com/alexandengstrom/birchrest/actions/workflows/type_checking.yml/badge.svg" />
<img alt="Linting" src="https://github.com/alexandengstrom/birchrest/actions/workflows/linting.yml/badge.svg" />
<a class="reference external" href="https://codecov.io/gh/alexandengstrom/birchrest"><img alt="codecov" src="https://codecov.io/gh/alexandengstrom/birchrest/branch/main/graph/badge.svg" /></a>
<a class="reference external" href="https://pypi.org/project/birchrest/"><img alt="Downloads" src="https://img.shields.io/pypi/dm/birchrest" /></a>
<a class="reference external" href="https://alexandengstrom.github.io/birchrest/"><img alt="Docs" src="https://img.shields.io/badge/docs-GitHub%20Pages-blue" /></a>
<img alt="GitHub last commit" src="https://img.shields.io/github/last-commit/alexandengstrom/birchrest" />
<img alt="Repo Size" src="https://img.shields.io/github/repo-size/alexandengstrom/birchrest" /></p>
<p><strong>BirchRest</strong> is a simple, lightweight framework for setting up RESTful APIs with minimal configuration. It is designed to be intuitive and flexible.</p>
<p>Full documentation is available here:
https://alexandengstrom.github.io/birchrest</p>
<section id="quickstart">
<h3>Quickstart<a class="headerlink" href="#quickstart" title="Link to this heading"></a></h3>
<ol class="arabic">
<li><p><strong>Install</strong>: You can install the latest version of birchrest     using pip:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>birchrest
</pre></div>
</div>
</li>
<li><p><strong>Init</strong>: Create a boilerplate project with <code class="docutils literal notranslate"><span class="pre">birch</span> <span class="pre">init</span></code> command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>birch<span class="w"> </span>init
</pre></div>
</div>
</li>
<li><p><strong>Start</strong>: Start the server via command line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>birch<span class="w"> </span>serve
</pre></div>
</div>
</li>
</ol>
</section>
<section id="table-of-contents">
<h3>Table of Contents<a class="headerlink" href="#table-of-contents" title="Link to this heading"></a></h3>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#introduction"><span class="xref myst">Introduction</span></a></p></li>
<li><p><a class="reference internal" href="#defining-controllers"><span class="xref myst">Defining Controllers</span></a></p>
<ul class="simple">
<li><p><a class="reference internal" href="#key-concepts"><span class="xref myst">Key Concepts</span></a></p></li>
<li><p><a class="reference internal" href="#defining-endpoints"><span class="xref myst">Defining Endpoints</span></a></p></li>
<li><p><a class="reference internal" href="#nesting-controllers"><span class="xref myst">Nesting Controllers</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="birchrest.html#birchrest.BirchRest.middleware" title="birchrest.BirchRest.middleware"><span class="xref myst py py-meth">Middleware</span></a></p>
<ul class="simple">
<li><p><a class="reference internal" href="#custom-middlewares"><span class="xref myst">Custom Middlewares</span></a></p></li>
<li><p><a class="reference internal" href="#built-in-middlewares"><span class="xref myst">Built-in Middlewares</span></a></p>
<ul>
<li><p><a class="reference internal" href="#rate-limiter"><span class="xref myst">Rate Limiter</span></a></p></li>
<li><p><a class="reference internal" href="birchrest.middlewares.html#module-birchrest.middlewares.cors" title="birchrest.middlewares.cors"><span class="xref myst py py-mod">Cors</span></a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#data-validation"><span class="xref myst">Data Validation</span></a></p>
<ul class="simple">
<li><p><a class="reference internal" href="#query-and-url-param-validation"><span class="xref myst">Query and URL Param Validation</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#authentication"><span class="xref myst">Authentication</span></a></p>
<ul class="simple">
<li><p><a class="reference internal" href="#custom-auth-handlers"><span class="xref myst">Custom Auth Handlers</span></a></p></li>
<li><p><a class="reference internal" href="#protecting-routes"><span class="xref myst">Protecting Routes</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#error-handling"><span class="xref myst">Error Handling</span></a></p>
<ul class="simple">
<li><p><a class="reference internal" href="#apierror"><span class="xref myst">ApiError</span></a></p></li>
<li><p><a class="reference internal" href="#custom-error-handler"><span class="xref myst">Custom Error Handler</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#unit-testing"><span class="xref myst">Unit Testing</span></a></p>
<ul class="simple">
<li><p><a class="reference internal" href="#test-adapter"><span class="xref myst">Test Adapter</span></a></p></li>
<li><p><a class="reference internal" href="#birchresttestcase"><span class="xref myst">BirchRestTestCase</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#request-and-response-lifecycle-in-birchrest"><span class="xref myst">Request and Response Lifecycle in BirchRest</span></a></p>
<ul class="simple">
<li><p><a class="reference internal" href="#1-receiving-and-parsing-the-request"><span class="xref myst">Receiving and Parsing the Request</span></a></p></li>
<li><p><a class="reference internal" href="#2-passing-the-request-to-the-app"><span class="xref myst">Passing the Request to the App</span></a></p></li>
<li><p><a class="reference internal" href="#3-handling-the-request-in-the-app"><span class="xref myst">Handling the Request in the App</span></a></p></li>
<li><p><a class="reference internal" href="#4-route-execution"><span class="xref myst">Route Execution</span></a></p></li>
<li><p><a class="reference internal" href="#5-returning-the-response"><span class="xref myst">Returning the Response</span></a></p></li>
</ul>
</li>
</ol>
</section>
<section id="introduction">
<h3>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h3>
<p>BirchRest follows a controller-based architecture, where each controller represents a logical grouping of API routes. The framework automatically constructs your API at runtime from the controllers you define. To make this work, simply create a file named <code class="docutils literal notranslate"><span class="pre">__birch__.py</span></code> and import all your controllers into this file. BirchRest will use this file to discover and configure your API routes.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">birchrest</span> <span class="kn">import</span> <span class="n">Controller</span>
<span class="kn">from</span> <span class="nn">birchrest.decorators</span> <span class="kn">import</span> <span class="n">get</span><span class="p">,</span> <span class="n">controller</span>
<span class="kn">from</span> <span class="nn">birchrest.http</span> <span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>

<span class="nd">@controller</span><span class="p">(</span><span class="s2">&quot;api&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>

    <span class="nd">@get</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello from the app!&quot;</span><span class="p">})</span>
</pre></div>
</div>
<p>To start the server, instantiate the BirchRest class and call its serve method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">birchrest</span> <span class="kn">import</span> <span class="n">BirchRest</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">BirchRest</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">serve</span><span class="p">()</span>
</pre></div>
</div>
<p>Or start the server via command line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>birch<span class="w"> </span>serve<span class="w"> </span>--port<span class="w"> </span><span class="o">[</span>PORT<span class="o">]</span><span class="w"> </span>--host<span class="w"> </span><span class="o">[</span>HOST<span class="o">]</span><span class="w"> </span>--log-level<span class="w"> </span><span class="o">[</span>LOG_LEVEL<span class="o">]</span>
</pre></div>
</div>
</section>
<section id="defining-controllers">
<h3>Defining Controllers<a class="headerlink" href="#defining-controllers" title="Link to this heading"></a></h3>
<p>In Birchrest, controllers are the building blocks of your API. Each controller defines multiple endpoints, and controllers can be nested to create hierarchical routes.</p>
<section id="key-concepts">
<h4>Key Concepts<a class="headerlink" href="#key-concepts" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p><strong>Base Path</strong>: Each controller has a base path that defines where its routes are accessible. If a controller has subcontrollers, their base paths are combined, creating a nested structure.</p></li>
<li><p><strong>Controller Setup</strong>: To create a controller:</p>
<ol class="arabic simple">
<li><p>Inherit from the Controller class</p></li>
<li><p>Use the &#64;controller decorator on the class, passing the base path as an argument.</p></li>
</ol>
</li>
</ul>
</section>
<section id="defining-endpoints">
<h4>Defining Endpoints<a class="headerlink" href="#defining-endpoints" title="Link to this heading"></a></h4>
<p>Inside a controller, use HTTP method decorators like &#64;get or &#64;post to define endpoints. These decorators can take an optional path to extend the controller’s base path for that specific route.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create an endpoint that accepts PATCH method on route /myendpoint.</span>
<span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;myendpoint&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">})</span>
</pre></div>
</div>
<p>To define path variables, use a colon (<code class="docutils literal notranslate"><span class="pre">:</span></code>) in the path. You can then access these variables through the <code class="docutils literal notranslate"><span class="pre">req.params</span></code> object.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@get</span><span class="p">(</span><span class="s2">&quot;user/:id&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
    <span class="n">userId</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">userId</span><span class="p">})</span>
</pre></div>
</div>
<p>A route can also access queries in the same way:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@get</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">queries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">})</span>
</pre></div>
</div>
<p>It is possible to set automatic contraints for the body, queries and params via validation decorators. See section about validation.</p>
<p>BirchRest is fully asynchronous, meaning all route handlers and middleware must be defined as async functions. This allows the framework to handle multiple requests concurrently without blocking. Ensure that all I/O-bound operations, such as database queries, file handling, or external API requests, are awaited properly. Failing to use async or forgetting to await asynchronous operations can lead to blocking behavior, defeating the purpose of using an asynchronous framework.</p>
</section>
<section id="nesting-controllers">
<h4>Nesting Controllers<a class="headerlink" href="#nesting-controllers" title="Link to this heading"></a></h4>
<p>BirchRest supports hierarchical route structures by allowing controllers to inherit from other controllers. This creates nested routes where the child controller’s base path is combined with the parent controller’s base path. In BirchRest, subcontrollers are created by having one controller class inherit from another controller class.</p>
<p>This approach makes it easy to group related endpoints under a common path and manage them as a logical structure.</p>
<section id="example">
<h5>Example<a class="headerlink" href="#example" title="Link to this heading"></a></h5>
<p>Let’s say we have a base API controller and we want to nest a resource controller under it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">birchrest</span> <span class="kn">import</span> <span class="n">Controller</span>
<span class="kn">from</span> <span class="nn">birchrest.decorators</span> <span class="kn">import</span> <span class="n">get</span><span class="p">,</span> <span class="n">controller</span>
<span class="kn">from</span> <span class="nn">birchrest.http</span> <span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>

<span class="c1"># Define the parent controller</span>
<span class="nd">@controller</span><span class="p">(</span><span class="s2">&quot;api&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BaseController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
    <span class="nd">@get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;API is running&quot;</span><span class="p">})</span>

<span class="c1"># Define the child controller that inherits from the parent</span>
<span class="nd">@controller</span><span class="p">(</span><span class="s2">&quot;resource&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ResourceController</span><span class="p">(</span><span class="n">BaseController</span><span class="p">):</span>
    <span class="nd">@get</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello from resource!&quot;</span><span class="p">})</span>

</pre></div>
</div>
<p>This will create the endpoint /api/resouce/hello.</p>
<p>In this example:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">BaseController</span></code> is the parent controller that handles routes under <code class="docutils literal notranslate"><span class="pre">/api</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">ResourceController</span></code> inherits from <code class="docutils literal notranslate"><span class="pre">BaseController</span></code>, making it a child controller nested under <code class="docutils literal notranslate"><span class="pre">/api/resource</span></code>.</p></li>
<li><p>The route for the “hello” endpoint in <code class="docutils literal notranslate"><span class="pre">ResourceController</span></code> becomes <code class="docutils literal notranslate"><span class="pre">/api/resource/hello</span></code>.</p></li>
<li><p>The route for the “status” endpoint from <code class="docutils literal notranslate"><span class="pre">BaseController</span></code> is <code class="docutils literal notranslate"><span class="pre">/api/status</span></code>.</p></li>
</ul>
<p>By inheriting from BaseController, the ResourceController becomes a child, automatically inheriting and extending the parent’s routing structure.</p>
</section>
</section>
</section>
<section id="middleware">
<h3>Middleware<a class="headerlink" href="#middleware" title="Link to this heading"></a></h3>
<p>Middleware allows you to perform tasks before or after a request is processed by a controller, such as logging, modifying the request, or checking permissions. Birchrest provides built-in middleware for common tasks and the ability to define your own custom middleware.</p>
<section id="custom-middlewares">
<h4>Custom Middlewares<a class="headerlink" href="#custom-middlewares" title="Link to this heading"></a></h4>
<p>You can create custom middleware to handle specific logic or modify request and response objects. This section explains how to define and register middleware in your application.</p>
<p>Middleware operates hierarchically, meaning it applies to all routes below the point where it’s defined. You can set up global middleware directly at the application level, or use decorators on controllers and routes. When applied to a controller, the middleware will affect all routes within that controller, as well as any nested controllers attached to it. If applied to a route it will be applied only on that route.</p>
<section id="requirements">
<h5>Requirements<a class="headerlink" href="#requirements" title="Link to this heading"></a></h5>
<p>A middleware should be a class that inherits from the Middleware class and it must implement an async call method. The call method will receive a Request, Response and NextFunction. If the NextFunction is called the call will continue to the next middleware or route handler. If not called, we wont continue. The next function must be awaited.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">birchrest.http</span> <span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">Middleware</span>
<span class="kn">from</span> <span class="nn">birchrest.types</span> <span class="kn">import</span> <span class="n">NextFunction</span>
<span class="kn">from</span> <span class="nn">birchrest.exceptions</span> <span class="kn">import</span> <span class="n">BadRequest</span>

<span class="k">class</span> <span class="nc">MyMiddleware</span><span class="p">(</span><span class="n">Middleware</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span> <span class="nb">next</span><span class="p">:</span> <span class="n">NextFunction</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
            <span class="k">await</span> <span class="nb">next</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadRequest</span>
</pre></div>
</div>
<p>It is possible to execute things after next is called aswell, this means you can use middlewares for postprocessing aswell. Just like route handlers, all middleware in BirchRest must be asynchronous.</p>
</section>
</section>
<section id="built-in-middlewares">
<h4>Built-in Middlewares<a class="headerlink" href="#built-in-middlewares" title="Link to this heading"></a></h4>
<p>Birchrest comes with several built-in middleware options that help manage common use cases, such as request logging, rate limiting or CORS support. These can be easily added to your API with minimal configuration. These can be imported from the middlewares module.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">birchrest.middlewares</span> <span class="kn">import</span> <span class="n">Cors</span><span class="p">,</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">RateLimiter</span>
</pre></div>
</div>
<section id="rate-limiter">
<h5>Rate Limiter<a class="headerlink" href="#rate-limiter" title="Link to this heading"></a></h5>
<p>The RateLimiter middleware in BirchRest helps protect your API from abuse by limiting the number of requests a client (identified by their IP address or token) can make within a specified time window. It is particularly useful for preventing denial-of-service (DoS) attacks or enforcing fair usage limits.</p>
<section id="how-it-works">
<h6>How it works:<a class="headerlink" href="#how-it-works" title="Link to this heading"></a></h6>
<ul class="simple">
<li><p>The rate limiter tracks the number of requests made by each client within a rolling time window.</p></li>
<li><p>If a client exceeds the allowed number of requests within the window, the middleware responds with a <code class="docutils literal notranslate"><span class="pre">429</span> <span class="pre">Too</span> <span class="pre">Many</span> <span class="pre">Requests</span></code> error.</p></li>
<li><p>Requests older than the current time window are automatically cleared from the log to allow new requests.</p></li>
</ul>
</section>
<section id="configuration-options">
<h6>Configuration Options:<a class="headerlink" href="#configuration-options" title="Link to this heading"></a></h6>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">max_requests</span></code>: The maximum number of requests a client can make within the time window (default is 2).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">window_seconds</span></code>: The length of the time window in seconds during which the requests are counted (default is 10 seconds).</p></li>
</ul>
</section>
<section id="id1">
<h6>Example:<a class="headerlink" href="#id1" title="Link to this heading"></a></h6>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">birchrest.middlewares</span> <span class="kn">import</span> <span class="n">RateLimiter</span>

<span class="c1"># Apply rate limiting globally</span>
<span class="n">app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="n">RateLimiter</span><span class="p">(</span><span class="n">max_requests</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">window_seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">))</span>
</pre></div>
</div>
<p>In this example, the middleware limits each client to a maximum of 5 requests per 60 seconds. If the limit is exceeded, any additional requests within that time will receive a <code class="docutils literal notranslate"><span class="pre">429</span></code> error response.</p>
</section>
</section>
<section id="cors">
<h5>Cors<a class="headerlink" href="#cors" title="Link to this heading"></a></h5>
<p>The CORS (<code class="docutils literal notranslate"><span class="pre">Cross-Origin</span> <span class="pre">Resource</span> <span class="pre">Sharing</span></code>) middleware in BirchRest enables your API to respond to cross-origin requests securely by controlling which origins, methods, and headers are allowed. It also handles preflight (<code class="docutils literal notranslate"><span class="pre">OPTIONS</span></code>) requests for methods other than <code class="docutils literal notranslate"><span class="pre">GET</span></code> and <code class="docutils literal notranslate"><span class="pre">POST</span></code>, or when using custom headers.</p>
<section id="id2">
<h6>How It Works:<a class="headerlink" href="#id2" title="Link to this heading"></a></h6>
<ul class="simple">
<li><p>The middleware inspects each request and adds the necessary CORS headers to the response based on the configured settings. This allows browsers to enforce the CORS policy and determine if the request is permitted.</p></li>
<li><p>For preflight requests (<code class="docutils literal notranslate"><span class="pre">OPTIONS</span></code> method), it sends the appropriate response headers to indicate which origins, methods, and headers are allowed.</p></li>
<li><p>For regular requests, it ensures the appropriate headers are added to allow cross-origin resource sharing.</p></li>
</ul>
</section>
<section id="id3">
<h6>Configuration Options:<a class="headerlink" href="#id3" title="Link to this heading"></a></h6>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">allow_origins</span></code>: List of allowed origins (default is [“*”], allowing all origins).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">allow_methods</span></code>: List of allowed HTTP methods (default includes GET, POST, PUT, DELETE, PATCH, OPTIONS).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">allow_headers</span></code>: List of allowed request headers (default is [“Content-Type”, “Authorization”]).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">allow_credentials</span></code>: Whether credentials (cookies, HTTP authentication, etc.) are allowed (default is False).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_age</span></code>: The time (in seconds) that preflight request results can be cached by the browser (default is 86400 seconds or 24 hours).</p></li>
</ul>
</section>
<section id="id4">
<h6>Example:<a class="headerlink" href="#id4" title="Link to this heading"></a></h6>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">birchrest.middlewares</span> <span class="kn">import</span> <span class="n">Cors</span>

<span class="c1"># Apply CORS middleware globally with default settings</span>
<span class="n">app</span><span class="o">.</span><span class="n">middleware</span><span class="p">(</span><span class="n">Cors</span><span class="p">(</span><span class="n">allow_origins</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;https://example.com&quot;</span><span class="p">],</span> <span class="n">allow_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
<p>In this example, only requests from https://example.com are allowed, and credentials (like cookies) are permitted to be sent with cross-origin requests. The middleware ensures that the appropriate CORS headers are added to all responses.</p>
</section>
</section>
</section>
</section>
<section id="data-validation">
<h3>Data Validation<a class="headerlink" href="#data-validation" title="Link to this heading"></a></h3>
<p>Data validation in Birchrest is supported via Python data classes. This allows for strict validation of request data (body, queries, and params) to ensure that all incoming data adheres to the expected structure.</p>
<p>To be able to use validation, you must also define the models.</p>
<section id="body-validation">
<h4>Body Validation<a class="headerlink" href="#body-validation" title="Link to this heading"></a></h4>
<section id="id5">
<h5>Example:<a class="headerlink" href="#id5" title="Link to this heading"></a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Address</span><span class="p">:</span>
    <span class="n">street</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;min_length&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;max_length&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">})</span>
    <span class="n">city</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;min_length&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;max_length&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">})</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;min_length&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;max_length&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;regex&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;^[\w\.-]+@[\w\.-]+\.\w+$&quot;</span><span class="p">})</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;min_value&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;max_value&quot;</span><span class="p">:</span> <span class="mi">120</span><span class="p">})</span>
    <span class="n">address</span><span class="p">:</span> <span class="n">Address</span>
</pre></div>
</div>
<p>You can then use the &#64;body, &#64;queries and &#64;params decorator with the dataclass as argument.</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@post</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>
<span class="nd">@body</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
    <span class="c1"># It is safe to pass the body directly since we have already validated it.</span>
    <span class="n">save_to_database</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="mi">201</span><span class="p">)</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
</pre></div>
</div>
<p>If the validation fails, the user will get an automatic response. For example, if we try to post a user to the route above but passes a username with only two letters. We will receive this response:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">400</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;code&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Bad Request&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;correlationId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;67ad2218-262e-478b-b767-04cfafd4315b&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Body validation failed: Field &#39;username&#39; must have at least 3 characters.&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Read more about how automatic error responses are handled in the error section.</p>
</section>
</section>
<section id="query-and-url-param-validation">
<h4>Query and URL Param Validation<a class="headerlink" href="#query-and-url-param-validation" title="Link to this heading"></a></h4>
<p>Validating queries and params is done in the same way, just use the &#64;queries and &#64;params decorators instead.</p>
</section>
<section id="supported-validation-constraints">
<h4>Supported Validation Constraints<a class="headerlink" href="#supported-validation-constraints" title="Link to this heading"></a></h4>
<p>Below is a list of all the validation constraints you can define using <code class="docutils literal notranslate"><span class="pre">field(metadata={...})</span></code>:</p>
<ol class="arabic">
<li><p><strong>Type Validation</strong>: Data is automatically validated against the field’s type. Supported types include int, float, str, list, and nested dataclasses.
Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span>
</pre></div>
</div>
</li>
<li><p><strong>String Constraints</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">min_length</span></code>: Ensures that the string has at least a certain number of characters.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_length</span></code>: Ensures that the string does not exceed a certain number of characters.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">regex</span></code>: Ensures that the string matches a given regular expression.</p></li>
<li><p>Example:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;min_length&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;max_length&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;regex&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;[^@]+@[^@]+\.[^@]+&quot;</span><span class="p">})</span>

</pre></div>
</div>
</li>
<li><p><strong>Numeric Constraints</strong>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">min_value</span></code>: Ensures that the number is at least a certain value.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_value</span></code>: Ensures that the number does not exceed a certain value.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Example</span></code>:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;min_value&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="s2">&quot;max_value&quot;</span><span class="p">:</span> <span class="mi">120</span><span class="p">})</span>

</pre></div>
</div>
</li>
<li><p><strong>Optional Fields</strong>:</p>
<ul class="simple">
<li><p>Fields can be marked as optional by specifying <code class="docutils literal notranslate"><span class="pre">is_optional:</span> <span class="pre">True</span></code> in the metadata. This allows a field to be omitted from the input data without causing a validation error.</p></li>
<li><p>Example:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">age</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;is_optional&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    <span class="n">phone</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;is_optional&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;regex&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;^\d</span><span class="si">{10}</span><span class="s2">$&quot;</span><span class="p">})</span>

</pre></div>
</div>
</li>
<li><p><strong>List Constraints</strong>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">min_items</span></code>: Ensures that a list has at least a certain number of items.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_items</span></code>: Ensures that a list does not exceed a certain number of items.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unique</span></code>: Ensures that all items in the list are unique.</p></li>
<li><p>You can also nest dataclasses inside lists and apply validation to each item.</p></li>
<li><p>Example:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Address</span><span class="p">:</span>
    <span class="n">street</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;min_length&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;max_length&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">})</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">addresses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Address</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;min_items&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;max_items&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>

</pre></div>
</div>
</li>
<li><p><strong>Nested Dataclasses</strong>:</p>
<ul class="simple">
<li><p>You can nest dataclasses inside each other, and BirchRest will automatically validate nested structures.</p></li>
<li><p>Example:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">ContactInfo</span><span class="p">:</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;regex&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;[^@]+@[^@]+\.[^@]+&quot;</span><span class="p">})</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">:</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;min_length&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;max_length&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">})</span>
    <span class="n">contact_info</span><span class="p">:</span> <span class="n">ContactInfo</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="authentication">
<h3>Authentication<a class="headerlink" href="#authentication" title="Link to this heading"></a></h3>
<p>Birchrest makes it easy to protect your API routes with authentication mechanisms. It allows you to define custom authentication handlers and easily mark routes as protected, ensuring that only authenticated requests are allowed access.</p>
<section id="custom-auth-handlers">
<h4>Custom Auth Handlers<a class="headerlink" href="#custom-auth-handlers" title="Link to this heading"></a></h4>
<p>You can define your own authentication handler to manage how users are authenticated in your system. Once defined, Birchrest will handle the integration with the API. If your route handler returns a falsy value or raises an Exception, the execution will be stopped. Otherwise the return value from this function will be put under the user property in the request object. It is therefore possible to put information there that tells you which user sent a request.</p>
</section>
<section id="protecting-routes">
<h4>Protecting Routes<a class="headerlink" href="#protecting-routes" title="Link to this heading"></a></h4>
<p>You can easily protect individual routes or entire controllers by marking them as requiring authentication. Birchrest will automatically handle unauthorized access by returning predefined error messages.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">birchrest</span> <span class="kn">import</span> <span class="n">BirchRest</span><span class="p">,</span> <span class="n">Controller</span>
<span class="kn">from</span> <span class="nn">birchrest.decorators</span> <span class="kn">import</span> <span class="n">get</span><span class="p">,</span> <span class="n">controller</span>
<span class="kn">from</span> <span class="nn">birchrest.http</span> <span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">auth_handler</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Authorization&quot;</span><span class="p">):</span>
        <span class="c1"># Do your logic</span>
        <span class="k">return</span> <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>

    <span class="k">return</span> <span class="kc">False</span>

<span class="nd">@controller</span><span class="p">(</span><span class="s2">&quot;api&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>

    <span class="nd">@protected</span><span class="p">()</span>
    <span class="nd">@get</span><span class="p">(</span><span class="s2">&quot;protected&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello from the app!&quot;</span><span class="p">})</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">BirchRest</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">MyController</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">serve</span><span class="p">()</span>

</pre></div>
</div>
</section>
</section>
<section id="error-handling">
<h3>Error Handling<a class="headerlink" href="#error-handling" title="Link to this heading"></a></h3>
<p>By default, BirchRest responds with standardized error messages and provides as much detail as possible when an error occurs. Common error responses like 404 (Not Found) when a route doesn’t exist, or 400 (Bad Request) when body validation fails, are handled automatically. If an unhandled exception occurs within your controllers, a 500 Internal Server Error will be returned.</p>
<section id="apierror">
<h4>ApiError<a class="headerlink" href="#apierror" title="Link to this heading"></a></h4>
<p>The <strong>ApiError</strong> class is the base class for a variety of HTTP exceptions such as NotFound, BadRequest, Unauthorized, and more. If any of these exceptions are raised during request handling, BirchRest will automatically convert them into the appropriate HTTP response with the correct status code and error message.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">birchrest.exceptions</span> <span class="kn">import</span> <span class="n">NotFound</span>

<span class="k">raise</span> <span class="n">NotFound</span>
</pre></div>
</div>
<p>This will automatically generate a 404 Not Found HTTP response to the client, with the provided user-friendly message.</p>
<p>Each ApiError has the following attributes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">status_code</span></code>: The HTTP status code (e.g., 404, 400, 500).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">base_message</span></code>: A default message associated with the status code (e.g., “Not Found” for 404).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">user_message</span></code>: An optional custom message that can provide more specific details about the error.</p></li>
</ul>
<p>BirchRest supports the following common HTTP exceptions out-of-the-box:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BadRequest</span></code> (400)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Unauthorized</span></code> (401)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Forbidden</span></code> (403)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NotFound</span></code> (404)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MethodNotAllowed</span></code> (405)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Conflict</span></code> (409)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">UnprocessableEntity</span></code> (422)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">InternalServerError</span></code> (500)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ServiceUnavailable</span></code> (503)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PaymentRequired</span></code> (402)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RequestTimeout</span></code> (408)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Gone</span></code> (410)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LengthRequired</span></code> (411)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PreconditionFailed</span></code> (412)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PayloadTooLarge</span></code> (413)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">UnsupportedMediaType</span></code> (415)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TooManyRequests</span></code> (429)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">UpgradeRequired</span></code> (426)</p></li>
</ul>
<p>The framework handles everything behind the scenes if any of these exceptions are raised. You don’t need to manually craft the response or worry about setting the correct status code—BirchRest takes care of it.</p>
</section>
<section id="custom-error-handler">
<h4>Custom Error Handler<a class="headerlink" href="#custom-error-handler" title="Link to this heading"></a></h4>
<p>If you need more control over how errors are handled, you can define your own custom error handler. This handler will receive the request, response, and exception as arguments. The handler must manage the exception explicitly; otherwise, a <code class="docutils literal notranslate"><span class="pre">500</span> <span class="pre">Internal</span> <span class="pre">Server</span> <span class="pre">Error</span></code> will be returned by default.</p>
<section id="id6">
<h5>Example:<a class="headerlink" href="#id6" title="Link to this heading"></a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">birchrest.http</span> <span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">birchrest.exceptions</span> <span class="kn">import</span> <span class="n">ApiError</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">error_handler</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ApiError</span><span class="p">):</span>
        <span class="c1"># If it an ApiError, use the build in converter if you want</span>
        <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">convert_to_response</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="c1"># Do your own error handling here...</span>
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;This was not supposed to happen....&quot;</span><span class="p">})</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="unit-testing">
<h3>Unit Testing<a class="headerlink" href="#unit-testing" title="Link to this heading"></a></h3>
<section id="test-adapter">
<h4>Test Adapter<a class="headerlink" href="#test-adapter" title="Link to this heading"></a></h4>
<p>To simplify testing, the framework includes a test adapter class that simulates sending HTTP requests to your API. This allows you to test everything except the server itself, with all middlewares, authentication handlers, and other components functioning exactly as they would in a real request. The adapter returns the final response object, which you can inspect and assert in your tests.</p>
<p>The TestAdapter class takes an instance of your app and then provides methods like get, post etc that accepts a path, headers and body.</p>
<section id="id7">
<h5>Example<a class="headerlink" href="#id7" title="Link to this heading"></a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">birchrest</span> <span class="kn">import</span> <span class="n">BirchRest</span>
<span class="kn">from</span> <span class="nn">birchrest.unittest</span> <span class="kn">import</span> <span class="n">TestAdapter</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">BirchRest</span><span class="p">()</span>
<span class="n">runner</span> <span class="o">=</span> <span class="n">TestAdapter</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/your-route&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="birchresttestcase">
<h4>BirchRestTestCase<a class="headerlink" href="#birchresttestcase" title="Link to this heading"></a></h4>
<p>BirchRest also provides a custom TestCase class (BirchRestTestCase) that includes helper methods to make it easier to assert HTTP responses. These methods help ensure that your API responds as expected. Below is a list of the available assertion methods and their descriptions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">assertOk(response)</span></code>: Asserts that the response status code is in the range of 2xx, indicating a successful request.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">assertNotOk(response)</span></code>: Asserts that the response status code is not in the range of 2xx, indicating a failure.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">assertBadRequest(response)</span></code>: Asserts that the response status code is 400, indicating a Bad Request.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">assertNotFound(response)</span></code>: Asserts that the response status code is 404, indicating a resource was not found.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">assertUnauthorized(response)</span></code>: Asserts that the response status code is 401, indicating an Unauthorized request.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">assertForbidden(response)</span></code>: Asserts that the response status code is 403, indicating a Forbidden request.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">assertInternalServerError(response)</span></code>: Asserts that the response status code is 500, indicating an Internal Server Error.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">assertStatus(response,</span> <span class="pre">expected_status)</span></code>: Asserts that the response status code matches the expected_status.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">assertHasHeader(response,</span> <span class="pre">expected_key)</span></code>: Asserts that the response contains a specific header.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">assertHeader(response,</span> <span class="pre">header_name,</span> <span class="pre">expected_value)</span></code>: Asserts that a specific header in the response matches the expected value.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">assertRedirect(response,</span> <span class="pre">expected_url)</span></code>: Asserts that the response status is a redirect (3xx) and that the Location header matches the expected URL.</p></li>
<li><p>```assertBodyContains(response, expected_key)``: Asserts that the response body contains a specific property or key.</p></li>
</ul>
<section id="id8">
<h5>Example:<a class="headerlink" href="#id8" title="Link to this heading"></a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">from</span> <span class="nn">birchrest</span> <span class="kn">import</span> <span class="n">BirchRest</span>
<span class="kn">from</span> <span class="nn">birchrest.unittest</span> <span class="kn">import</span> <span class="n">TestAdapter</span><span class="p">,</span> <span class="n">BirchRestTestCase</span>

<span class="k">class</span> <span class="nc">ApiTest</span><span class="p">(</span><span class="n">BirchRestTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">BirchRest</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runner</span> <span class="o">=</span> <span class="n">TestAdapter</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">test_user_route</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/user&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertOk</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">test_invalid_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/user/0&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotOk</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStatus</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="request-and-response-lifecycle-in-birchrest">
<h3>Request and Response Lifecycle in BirchRest<a class="headerlink" href="#request-and-response-lifecycle-in-birchrest" title="Link to this heading"></a></h3>
<p>The BirchRest framework handles HTTP requests using a structured flow to ensure that all incoming requests are processed correctly, including middleware execution, validation, and error handling. This section explains the lifecycle of a request from when it is received by the server to when a response is sent back to the client.</p>
<section id="receiving-and-parsing-the-request">
<h4>1. Receiving and Parsing the Request<a class="headerlink" href="#receiving-and-parsing-the-request" title="Link to this heading"></a></h4>
<p>When a client sends an HTTP request to the server, the server parses the raw request data into a Request object. This object encapsulates all details about the incoming request, such as headers, method (e.g., GET, POST), query parameters, URL parameters, and body data.</p>
</section>
<section id="passing-the-request-to-the-app">
<h4>2. Passing the Request to the App<a class="headerlink" href="#passing-the-request-to-the-app" title="Link to this heading"></a></h4>
<p>Once the request object is created, it is passed to the main application (BirchRest) for handling. The app creates a new Response object, which will later be populated and returned to the client. The app then looks for a matching route by searching through all defined routes based on the request’s URL and HTTP method.</p>
</section>
<section id="handling-the-request-in-the-app">
<h4>3. Handling the Request in the App<a class="headerlink" href="#handling-the-request-in-the-app" title="Link to this heading"></a></h4>
<p>The main request handling logic is performed by the handle_request method in the app. This method attempts to match the incoming request to a route and execute the following key steps:</p>
<ul class="simple">
<li><p><strong>Route Matching</strong>: The app searches through all registered routes to find one that matches the URL path and HTTP method of the request. If a matching route is found, the request proceeds to that route. If no route matches, a <code class="docutils literal notranslate"><span class="pre">404</span> <span class="pre">Not</span> <span class="pre">Found</span></code> error is raised, or if the route exists but the HTTP method is incorrect, a <code class="docutils literal notranslate"><span class="pre">405</span> <span class="pre">Method</span> <span class="pre">Not</span> <span class="pre">Allowed</span></code> error is raised.</p></li>
<li><p><strong>Passing the Request to the Route</strong>: Once a route is matched, the app passes both the request and response objects to that route for further processing.</p></li>
<li><p><strong>Error Handling</strong>: If an exception occurs during request handling (such as an invalid request or missing route), the app catches the exception and attempts to generate an appropriate error response using predefined or custom error handlers.</p></li>
</ul>
</section>
<section id="route-execution">
<h4>4. Route Execution<a class="headerlink" href="#route-execution" title="Link to this heading"></a></h4>
<p>Each route in BirchRest is responsible for executing its logic and handling the request:</p>
<ul>
<li><p><strong>Middleware Execution</strong>: When the request reaches the matched route, the route begins by executing any middleware associated with it. Middleware can modify the request or response objects, perform tasks such as logging or authentication, and decide whether to continue processing the request. Middleware runs in a chain, meaning each middleware can pass control to the next one, or halt the chain and send a response early.</p>
<p>The route’s <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method initiates this process by calling the first middleware in the stack. If no middleware interrupts the chain, the request proceeds to the route handler.</p>
</li>
<li><p><strong>Authentication</strong>: If the route is protected by authentication, the request must pass through an authentication handler. This handler validates the request (e.g., checking tokens or credentials). If authentication fails, a <code class="docutils literal notranslate"><span class="pre">401</span> <span class="pre">Unauthorized</span></code> error is raised, and the response is sent back to the client.</p></li>
<li><p><strong>Validation</strong>: If the route requires validation of the request body, query parameters, or URL parameters, the request data is checked against predefined data classes. If the data fails validation (e.g., missing required fields or incorrect types), a 400 Bad Request error is raised.</p></li>
<li><p><strong>Executing the Route Handler</strong>: Once middleware, authentication, and validation checks pass, the route handler function is executed. The route handler is responsible for performing the main business logic, such as fetching data, processing the request, or interacting with external services. After processing, the route handler populates the response object with the appropriate data and status code.</p></li>
</ul>
</section>
<section id="returning-the-response">
<h4>5. Returning the Response<a class="headerlink" href="#returning-the-response" title="Link to this heading"></a></h4>
<p>After the route handler completes, the response object (which was initially created at the beginning of the request) contains the data to be sent back to the client. This includes the HTTP status code, headers, and response body.</p>
<p>The final response is then returned to the server, which sends it to the client. If any errors occurred during the request lifecycle, they are automatically converted into error responses by the app’s error handler.</p>
</section>
</section>
<section id="contributing">
<h3>Contributing<a class="headerlink" href="#contributing" title="Link to this heading"></a></h3>
<p>Contributions are welcome! Please refer to the <a class="reference internal" href="#./CONTRIBUTING.md"><span class="xref myst">CONTRIBUTING.md</span></a> file for details on how to get involved, submit pull requests, and report issues.</p>
</section>
<section id="license">
<h3>License<a class="headerlink" href="#license" title="Link to this heading"></a></h3>
<p>This project is licensed under the MIT License - see the <a class="reference internal" href="#./LICENSE"><span class="xref myst">LICENSE</span></a> file for details.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="modules.html" class="btn btn-neutral float-right" title="birchrest" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Alexander Engström.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>